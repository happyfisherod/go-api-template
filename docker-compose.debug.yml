version: "3.7"

services:
  app_api:
    build:
      context: .
      dockerfile: ./app/Dockerfile.api
      target: test
    ports:
      - "8000:8000" # API
      - "8180:8180" # Health
      - "9400:9400" # Prometheus
      - "40000:40000" # Remote Debug
    security_opt:
      - "seccomp:unconfined"
    cap_add:
      - SYS_PTRACE
    depends_on:
      - kafka
      - schemaregistry
    env_file:
      - ./app/.env.api.test
    volumes:
      - ./app/src:/app
      - ./schemas:/app/schemas

#  api:
#    build:
#      context: .
#      dockerfile: ./api/Dockerfile
#      target: test
#    ports:
#      - "8000:8000" # API
#      - "8180:8180" # Health
#      - "9400:9400" # Prometheus
#      - "40000:40000" # Remote Debug
#    security_opt:
#      - "seccomp:unconfined"
#    cap_add:
#      - SYS_PTRACE
#    depends_on:
#      - kafka
#      - schemaregistry
#    env_file:
#      - ./api/.env.test
#    volumes:
#      - ./api/src:/api
#      - ./schemas:/api/schemas

#  worker:
#    build:
#      context: .
#      dockerfile: worker/Dockerfile
#      target: test
#    ports:
#      - "9001:9001"
#      - "8181:8181"
#      - "40001:40001" # Remote Debug
#    security_opt:
#      - "seccomp:unconfined"
#    cap_add:
#      - SYS_PTRACE
#    depends_on:
#      - kafka
#      - schemaregistry
#    env_file:
#      - ./worker/.env.test
#    volumes:
#      - ./worker/src:/worker
#      - ./schemas:/worker/schemas

#  worker:
#    build:
#      context: .
#      dockerfile: worker/Dockerfile
#      target: test
#    ports:
#      - "9001:9001"
#      - "8181:8181"
#      - "40001:40001" # Remote Debug
#    security_opt:
#      - "seccomp:unconfined"
#    cap_add:
#      - SYS_PTRACE
#    depends_on:
#      - kafka
#      - schemaregistry
#    env_file:
#      - ./worker/.env.test
#    volumes:
#      - ./worker/src:/worker
#      - ./schemas:/worker/schemas

  mongo:
    image: mongo

  etl:
    image: geometrylabs/iconetl:${ICON_ETL_TAG:-latest}
    command: [
      "stream",
      "-o", "kafka:9092",
      "--period-seconds", "1",
      "--provider-uri", "http://134.122.40.114:9000/api/v3",
      "-b", "100",
    ]
    depends_on:
      - kafka
    restart: on-failure
    volumes:
      - "./last_synced_block.txt:/icon-etl/last_synced_block.txt"

  mongo-express:
    image: mongo-express
    depends_on:
      - mongo
    ports:
      - 8081:8081

